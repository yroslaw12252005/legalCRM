
{% extends "base.html" %}
{% load static %}
{% block content %}


<style>
    .tasks__list {
  margin: 0;
  padding: 0;

  list-style: none;
}
.tasks{
background-color: #212529;
}

.tasks__list {
  margin: 0;
  padding: 0;


  list-style: none;
}

.tasks__item {
  transition: background-color 0.5s;
  margin-bottom: 10px;
  padding: 5px;

  display: flex;
  justify-content: center;
  border-radius: 10px;
  cursor: move;

  transition: background-color 0.5s;

}

.tasks__item:last-child {
  margin-bottom: 0;
}

.selected {
  opacity: 0.6;
}
</style>
<link rel="stylesheet" href="{% static 'css/search.css' %}" />
<link rel="stylesheet" href="{% static 'css/table.css' %}" />
<link rel="stylesheet" href="{% static 'css/pole.css' %}" />

{% if user.is_authenticated %}
<div class="row">

<div class="row main_tb">
  <div class="col-12">
    <table class="table table-striped table-hover rounded-3">
  <thead>
     <tr class="table-success">
       <th scope="col"><p>Имя</p></th>
       <th scope="col"><p>Телефон</p></th>
       <th scope="col"><p>Описание</p></th>
       <th scope="col"><p>Источник</p></th>
       <th scope="col"><p>Статус заявки</p></th>
        {% if user.status == "Директор КЦ" or user.status == "Оператор" or user.status == "Администратор"%}
            <th scope="col"><p>В работе</p></th>
         {% endif %}
                  {% if user.status == "Директор КЦ" or user.status == "Администратор" or user.status == "Менеджер"%}
            <th scope="col"><p>Прикрепленный оператор</p></th>
         {% endif %}
         {% if user.status == "Директор ЮПП" or user.status == "Администратор" or user.status == "Менеджер"%}
            <th scope="col"><p>Прикрепленный юрист</p></th>
         {% endif %}
     </tr>
   </thead>
   <tbody>
    {% if records %}
      {% for record in records %}

        {% if user.status == "Директор КЦ" and record.in_work == 0 or user.status == "Директор КЦ" and record.in_work == 1 or user.status == "Директор ЮПП" and record.in_work == 1 or user.status == "Юрист пирвичник" and record.employees_UPP == user.username or user.status == "Оператор" and record.employees_KC == user.username or user.status == "Менеджер"  and record.in_work == 1 or user.status == "Администратор"%}
            <tr>
              <td class="table-default"><p><a href="{% url 'record' record.id %}" style="    text-decoration: none; color:#595959;">{{ record.name }}</a></p></td>
              <td class="table-default"><p>{{ record.phone }}</p></td>
              <td class="table-default"><p>{{ record.description|slice:"100" }}</p></td>
              <td class="table-default"><p>{{ record.where }}</p></td>
                {% if record.status == "Новая" %}
                <td class="table-default" style="color:#fff; background-color: #077EC2;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Брак" %}
                 <td class="table-default" style=" color:#fff; background-color: #C51010;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Недозвон" %}
                <td class="table-default" style="background-color: #595959;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Перезвон" %}
                <td class="table-default" style="background-color: #595959;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Запись в офис" %}
                <td class="table-default" style="background-color: #22C061;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Отказ" %}
                <td class="table-default" style="background-color: #C51010;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Онлайн" %}
                <td class="table-default" style="background-color: #E1C645;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Акт" %}
                <td class="table-default" style="background-color: #22C061;"><p style="color:#fff;">{{ record.status }}</p></td>
                {% elif record.status == "Договор" %}
                <td class="table-default" style="background-color: #CCCCFF;"><p style="color:#fff;">{{ record.status }}</p></td>
                {%endif%}
{% if user.status == "Директор КЦ" or user.status == "Оператор" or user.status == "Администратор"%}
            {% if record.in_work == 1%}
            <td style="background-color: #22C061;"><p style="color:#fff;">Да</p></td>
            {% else %}
            <td style="background-color: #C51010;"><p style="color:#fff;">Нет</p></td>
            {% endif %}
            {% endif %}
                                 {% if user.status == "Директор КЦ" or user.status == "Администратор" or user.status == "Менеджер"%}
             <td class="table-default"><p>{{ record.employees_KC }}</p></td>
         {% endif %}
                 {% if user.status == "Директор ЮПП" or user.status == "Администратор" or user.status == "Менеджер"%}
             <td class="table-default"><p>{{ record.employees_UPP }}</p></td>
         {% endif %}


            </tr>
    {% endif %}
      {% endfor %}
      {% endif %}
</tbody>
</table>

  </div>

</div>

<script>
const tasksListElement = document.querySelector(`.tasks__list`);
const taskElements = tasksListElement.querySelectorAll(`.tasks__item`);

// Перебираем все элементы списка и присваиваем нужное значение
for (const task of taskElements) {
  task.draggable = true;
}

    tasksListElement.addEventListener(`dragstart`, (evt) => {
  evt.target.classList.add(`selected`);
})

tasksListElement.addEventListener(`dragend`, (evt) => {
  evt.target.classList.remove(`selected`);
});

    tasksListElement.addEventListener(`dragover`, (evt) => {
  // Разрешаем сбрасывать элементы в эту область
  evt.preventDefault();

  // Находим перемещаемый элемент
  const activeElement = tasksListElement.querySelector(`.selected`);
  // Находим элемент, над которым в данный момент находится курсор
  const currentElement = evt.target;
  // Проверяем, что событие сработало:
  // 1. не на том элементе, который мы перемещаем,
  // 2. именно на элементе списка
  const isMoveable = activeElement !== currentElement &&
    currentElement.classList.contains(`tasks__item`);

  // Если нет, прерываем выполнение функции
  if (!isMoveable) {
    return;
  }

  // Находим элемент, перед которым будем вставлять
  const nextElement = (currentElement === activeElement.nextElementSibling) ?
      currentElement.nextElementSibling :
      currentElement;

  // Вставляем activeElement перед nextElement
  tasksListElement.insertBefore(activeElement, nextElement);
});

  const getNextElement = (cursorPosition, currentElement) => {
  // Получаем объект с размерами и координатами
  const currentElementCoord = currentElement.getBoundingClientRect();
  // Находим вертикальную координату центра текущего элемента
  const currentElementCenter = currentElementCoord.y + currentElementCoord.height / 2;

  // Если курсор выше центра элемента, возвращаем текущий элемент
  // В ином случае — следующий DOM-элемент
  const nextElement = (cursorPosition < currentElementCenter) ?
      currentElement :
      currentElement.nextElementSibling;

  return nextElement;
};

tasksListElement.addEventListener(`dragover`, (evt) => {
  evt.preventDefault();

  const activeElement = tasksListElement.querySelector(`.selected`);
  const currentElement = evt.target;
  const isMoveable = activeElement !== currentElement &&
    currentElement.classList.contains(`tasks__item`);

  if (!isMoveable) {
    return;
  }

  // evt.clientY — вертикальная координата курсора в момент,
  // когда сработало событие
  const nextElement = getNextElement(evt.clientY, currentElement);

  // Проверяем, нужно ли менять элементы местами
  if (
    nextElement &&
    activeElement === nextElement.previousElementSibling ||
    activeElement === nextElement
  ) {
    // Если нет, выходим из функции, чтобы избежать лишних изменений в DOM
    return;
  }

  tasksListElement.insertBefore(activeElement, nextElement);
});
</script>

{% else %}
    <div class="col-md-6 offset-md-3 pole">
        <h3>Добро пожаловать в  yblochkoCRM</h3>
        <form action="{% url 'home' %}" class="authenticated" method="post">
            {% csrf_token %}
            <div class="mb-3">
            <input type="text" class="form-control " name="username" placeholder="Имя" required>
            </div>
            <div class="mb-3">
            <input type="password" class="form-control" name="password" placeholder="Пароль" required>
            </div>
            <button type="submit" class="btn btn-success">Зайти</button>
        </form>
        </div>
{% endif %}
{% endblock content %}